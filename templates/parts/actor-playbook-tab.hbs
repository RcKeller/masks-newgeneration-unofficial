{{!-- Playbook Tab: Playbook Features, Moment of Truth, Advancements --}}
<div class="tab playbook" data-group="primary" data-tab="playbook">
	<section class="sheet-tab playbook-tab">
		{{!-- Playbook-Specific Features (all types) --}}
		{{!-- Use PbtA's built-in patterns for all attribute types --}}
		{{#if playbookAttributes}}
		<div class="playbook-section playbook-section--features">
			<label class="section-title">{{localize "MASKS-SHEETS.PlaybookFeatures"}}</label>
			<div class="playbook-features-list">
				{{#each playbookAttributes as |attr key|}}
				<div class="cell cell--{{key}} cell--attr-{{key}} cell--{{attr.type}} playbook-feature playbook-feature--{{attr.type}}" data-attr-key="{{key}}">
					<label for="system.attributes.{{key}}.value" class="cell__title feature-label">{{attr.label}}</label>
					{{#if attr.description}}
					<p class="cell__description cell__description--attr feature-description">{{attr.description}}</p>
					{{/if}}
					{{!-- Clock type (e.g., Doom Track) - Exact PbtA pattern --}}
					{{#if (eq attr.type "Clock")}}
					<div class="cell__clock flexrow">
						{{#times attr.max}}
						<input type="checkbox" class="attr-clock" data-name="system.attributes.{{key}}" data-step="{{@index}}" {{checked (gt attr.value @index)}}>
						{{/times}}
					</div>
					<span class="clock-count">{{attr.value}} / {{attr.max}}</span>
					{{!-- Number type (e.g., Nova's Burn, Soldier's Fight) - Exact PbtA pattern --}}
					{{else if (eq attr.type "Number")}}
					<div class="number-tracker">
						<button type="button" class="tracker-btn" data-action="decrease" data-attr="attributes.{{key}}.value">
							<i class="fas fa-minus"></i>
						</button>
						<input type="text" class="tracker-value" name="system.attributes.{{key}}.value" value="{{attr.value}}" data-dtype="Number" />
						<button type="button" class="tracker-btn" data-action="increase" data-attr="attributes.{{key}}.value">
							<i class="fas fa-plus"></i>
						</button>
					</div>
					{{!-- LongText type (e.g., Bull's Heart, Protege's Mentor) - Exact PbtA pattern --}}
					{{else if (eq attr.type "LongText")}}
					{{editor attr.enriched target=attr.attrName button=true owner=../owner editable=../editable}}
					{{!-- ListMany type (e.g., Drives, Doomed's Doom choices) - Exact PbtA pattern --}}
					{{else if (eq attr.type "ListMany")}}
					<ul class="cell__checkboxes flexcol">
						{{#each attr.options as |option optionKey|}}
						<label class="flexrow" {{#if option.tooltip}}data-tooltip="{{option.tooltip}}" data-tooltip-direction="UP"{{/if}}>
							{{#if option.values}}
								{{#each option.values as |suboption suboptionKey|}}
								<input type="checkbox" class="attr-list" name="system.attributes.{{key}}.options.{{optionKey}}.values.{{suboptionKey}}.value" {{checked suboption.value}} />
								{{/each}}
							{{else}}
								<input type="checkbox" class="attr-list" name="system.attributes.{{key}}.options.{{optionKey}}.value" {{checked option.value}} />
							{{/if}}
							{{#if (eq option.label "[Text]")}}
								<input type="text" class="input input-title" name="system.attributes.{{key}}.options.{{optionKey}}.userLabel" value="{{option.userLabel}}">
							{{else}}
								{{option.label}}
							{{/if}}
						</label>
						{{/each}}
					</ul>
					{{!-- Text type - Exact PbtA pattern --}}
					{{else if (eq attr.type "Text")}}
					<input type="text" class="input input--{{key}}" name="system.attributes.{{key}}.value" value="{{attr.value}}" />
					{{/if}}
				</div>
				{{/each}}
			</div>
		</div>
		{{/if}}

		{{!-- Moment of Truth --}}
		<div class="playbook-section playbook-section--moment">
			<div class="section-header">
				<label class="section-title">{{system.attributes.momentOfTruth.label}}</label>
				<label class="moment-unlock-toggle">
					<input type="checkbox" name="system.attributes.momentUnlocked.value" {{checked system.attributes.momentUnlocked.value}} />
					<span>{{system.attributes.momentUnlocked.checkboxLabel}}</span>
				</label>
			</div>
			{{#if system.attributes.momentOfTruth.description}}
			<p class="section-description">{{system.attributes.momentOfTruth.description}}</p>
			{{/if}}
			{{editor system.attributes.momentOfTruth.value target="system.attributes.momentOfTruth.value" button=true owner=owner editable=editable}}
		</div>

		{{!-- Combined Advancements Section --}}
		<div class="playbook-section playbook-section--combined-advances">
			{{!-- Regular Advancements --}}
			<div class="advances-subsection">
				<label class="subsection-title">{{system.attributes.advancements.label}}</label>
				{{#if system.attributes.advancements.description}}
				<p class="section-description">{{system.attributes.advancements.description}}</p>
				{{/if}}
				<ul class="cell__checkboxes flexcol">
					{{#each system.attributes.advancements.options as |option optionKey|}}
					<label class="flexrow" {{#if option.tooltip}}data-tooltip="{{option.tooltip}}" data-tooltip-direction="UP"{{/if}}>
						{{#if option.values}}
							{{#each option.values as |suboption suboptionKey|}}
							<input type="checkbox" class="attr-list" name="system.attributes.advancements.options.{{optionKey}}.values.{{suboptionKey}}.value" {{checked suboption.value}} />
							{{/each}}
						{{else}}
							<input type="checkbox" class="attr-list" name="system.attributes.advancements.options.{{optionKey}}.value" {{checked option.value}} />
						{{/if}}
						{{#if (eq option.label "[Text]")}}
						<input type="text" class="input input-title" name="system.attributes.advancements.options.{{optionKey}}.userLabel" value="{{option.userLabel}}" placeholder="Custom advancement...">
						{{else}}
						{{option.label}}
						{{/if}}
					</label>
					{{/each}}
				</ul>
			</div>

			{{!-- Divider --}}
			<hr class="advances-divider" />

			{{!-- Later Advances --}}
			<div class="advances-subsection advances-subsection--later">
				<label class="subsection-title">{{system.attributes.laterAdvances.label}}</label>
				{{#if system.attributes.laterAdvances.description}}
				<p class="section-description">{{system.attributes.laterAdvances.description}}</p>
				{{/if}}
				<ul class="cell__checkboxes flexcol">
					{{#each system.attributes.laterAdvances.options as |option optionKey|}}
					<label class="flexrow" {{#if option.tooltip}}data-tooltip="{{option.tooltip}}" data-tooltip-direction="UP"{{/if}}>
						{{#if option.values}}
							{{#each option.values as |suboption suboptionKey|}}
							<input type="checkbox" class="attr-list" name="system.attributes.laterAdvances.options.{{optionKey}}.values.{{suboptionKey}}.value" {{checked suboption.value}} />
							{{/each}}
						{{else}}
							<input type="checkbox" class="attr-list" name="system.attributes.laterAdvances.options.{{optionKey}}.value" {{checked option.value}} />
						{{/if}}
						{{#if (eq option.label "[Text]")}}
						<input type="text" class="input input-title" name="system.attributes.laterAdvances.options.{{optionKey}}.userLabel" value="{{option.userLabel}}" placeholder="Custom advancement...">
						{{else}}
						{{option.label}}
						{{/if}}
					</label>
					{{/each}}
				</ul>
			</div>
		</div>
	</section>
</div>
