{{!-- Call Sheet Template - Dispatch-style vignette assignment UI --}}
<form class="call-sheet {{#if isQualified}}call-sheet--qualified{{/if}} {{fitClass}}" autocomplete="off">
  {{!-- Main Content Area - 2 Column Layout --}}
  <section class="call-sheet__top">
    {{!-- Left Panel: Call Type, Caller Info, The Call (2/3 width) --}}
    <div class="call-sheet__left-panel">
      <header class="call-sheet__type-header">
        <i class="call-type-icon {{currentTypeIcon}}"></i>
        {{#if canEdit}}
          <select class="call-type-select" data-action="change-call-type">
            {{#each callTypeOptions}}
              <option value="{{this.key}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
            {{/each}}
          </select>
        {{else}}
          <span class="call-type-label">
            {{#each callTypeOptions}}
              {{#if this.selected}}{{this.label}}{{/if}}
            {{/each}}
          </span>
        {{/if}}
      </header>

      <div class="call-sheet__caller">
        <label class="caller-label">{{localize "DISPATCH.Call.CallerName"}}</label>
        {{#if canEdit}}
          <input type="text" class="caller-name-input" value="{{callerName}}" data-action="change-caller-name" placeholder="Anonymous" />
        {{else}}
          <span class="caller-name">{{callerName}}</span>
        {{/if}}
      </div>

      {{!-- GM Controls - Reset button and preview fit (GM only) --}}
      {{#if isGM}}
      <div class="call-sheet__gm-controls">
        <button type="button" class="gm-reset-btn" data-action="reset-call">
          <i class="fa-solid fa-rotate-left"></i> Reset Call
        </button>
        {{!-- Preview Fit Indicator (shows before dispatch, GM only) --}}
        {{#unless isQualified}}
          {{#if previewFitLabel}}
            <div class="preview-fit-indicator {{previewFitClass}}">
              {{previewFitLabel}}
            </div>
          {{/if}}
        {{/unless}}
      </div>
      {{/if}}

      {{!-- GM Stats Table - Compact, in right column --}}
      {{#if canSeeBottom}}
      <div class="call-sheet__gm-stats">
        <header class="gm-stats-header">
          <i class="fa-solid fa-lock"></i>
          <span>Stats</span>
        </header>
        <table class="call-sheet__stats-table">
          <thead>
            <tr>
              <th class="stat-col-label"></th>
              <th class="stat-col-req">Req</th>
              <th class="stat-col-hero">Hero</th>
              <th class="stat-col-diff"></th>
            </tr>
          </thead>
          <tbody>
            {{#each labelRows}}
              <tr class="stat-row stat-row--{{this.key}}">
                <td class="stat-label">{{this.label}}</td>
                <td class="stat-req">
                  <input type="number" class="stat-input requirement-input"
                         data-action="change-requirement"
                         data-label="{{this.key}}"
                         value="{{#if this.hasRequirement}}{{this.requirement}}{{/if}}"
                         min="-3" max="4"
                         placeholder="-" />
                </td>
                <td class="stat-hero {{#unless this.hasHeroValue}}hero-value--none{{/unless}}">
                  {{#if this.hasHeroValue}}{{this.heroValue}}{{else}}-{{/if}}
                </td>
                <td class="stat-diff {{#if this.met}}diff--met{{else}}diff--unmet{{/if}}">
                  {{#if this.hasRequirement}}
                    {{#if this.met}}
                      <i class="fa-solid fa-check"></i>
                    {{else}}
                      <i class="fa-solid fa-xmark"></i>
                    {{/if}}
                  {{else}}
                    -
                  {{/if}}
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      <div class="call-sheet__quote">
        <label class="quote-label">{{localize "DISPATCH.Call.Quote"}}</label>
        {{#if canEdit}}
          <div class="editor-wrapper quote-editor-wrapper" data-edit="callerQuote">
            {{{editor callerQuote target="flags.masks-newgeneration-unofficial.callerQuote" button=false editable=true engine="prosemirror"}}}
          </div>
        {{else}}
          <blockquote class="quote-text">{{{callerQuote}}}</blockquote>
        {{/if}}
      </div>
    </div>

    {{!-- Right Panel: Title, Graph, Assignment, Dispatch, GM Stats (1/3 width) --}}
    <div class="call-sheet__right-panel">
      <header class="call-sheet__title">
        <input type="text" class="call-title-input" name="name" value="{{actor.name}}" {{#unless canEdit}}disabled{{/unless}} placeholder="Call Title" />
      </header>

      {{!-- Overlay Graph Preview --}}
      <div class="call-sheet__graph" data-graph-container data-tooltip="{{overlayGraph.tooltip}}" data-tooltip-direction="UP">
        {{{overlayGraph.svg}}}
        {{#if previewActor}}
          <div class="graph-preview-label">Preview: {{previewActor.name}}</div>
        {{/if}}
      </div>


      {{!-- No Combat Warning --}}
      {{#if noCombatWarning}}
        <div class="call-sheet__no-combat-warning">
          <i class="fa-solid fa-exclamation-triangle"></i>
          <span>No active combat. Start a combat encounter to assign heroes.</span>
        </div>
      {{/if}}

      {{!-- Assignment with View Hero Button - everyone can interact --}}
      <div class="call-sheet__assignment">
        <label class="assignment-label">{{localize "DISPATCH.Call.AssignedHero"}}</label>
        <div class="assignment-controls">
          <select class="hero-select" data-action="assign-hero" {{#if isQualified}}disabled{{/if}} {{#if noCombatWarning}}disabled{{/if}}>
            <option value="">{{#if noCombatWarning}}-- No Combat Active --{{else}}-- Select Hero --{{/if}}</option>
            {{#each characterActors}}
              <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.name}}</option>
            {{/each}}
          </select>
          <button type="button" class="view-hero-btn" data-action="view-hero" {{#unless assignedActor}}disabled{{/unless}} data-tooltip="View Hero Sheet">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      {{!-- Dispatch Button --}}
      <div class="call-sheet__dispatch">
        {{#if isQualified}}
          <div class="dispatch-result fit-badge {{fitClass}}">
            <span class="fit-label">{{fitLabel}}</span>
          </div>
        {{else if isAssessing}}
          <button type="button" class="dispatch-btn dispatch-btn--assessing" disabled>
            <i class="fa-solid fa-spinner fa-spin"></i> {{localize "DISPATCH.Call.Assessing"}}
          </button>
        {{else}}
          <button type="button" class="dispatch-btn" data-action="dispatch" {{#unless canDispatch}}disabled{{/unless}}>
            <i class="fa-solid fa-paper-plane"></i> {{localize "DISPATCH.Call.Dispatch"}}
          </button>
        {{/if}}
        {{#if isGM}}
          <button type="button" class="dispatch-reset-btn" data-action="reset-call">
            <i class="fa-solid fa-rotate-left"></i> Reset
          </button>
        {{/if}}
        {{#if forwardMessage}}
          <div
            class="forward-message {{#if (gt forwardChange 0)}}forward--positive{{else if (lt forwardChange 0)}}forward--negative{{/if}}">
            {{forwardMessage}}
          </div>
        {{/if}}
      </div>

      {{!-- Dynamic Preview Fit Indicator (shows before dispatch, GM only) --}}
      {{#unless isQualified}}
        {{#if previewFitLabel}}
          <div class="preview-fit-indicator {{previewFitClass}}">
            {{previewFitLabel}}
          </div>
        {{/if}}
      {{/unless}}
    </div>
  </section>
</form>
