/* =============================================================================
   MASKS: A NEW GENERATION - Unified Theme System
   =============================================================================
   This file contains all styling for the Masks FoundryVTT module.
   Color scheme: Blue/dark superhero theme throughout (character sheet + turn cards)
   ============================================================================= */

/* =============================================================================
   THEME VARIABLES - Single source of truth for all colors
   ============================================================================= */

:root {
  /* --- Core Color Palette --- */
  --masks-blue-dark: #0e2949;
  --masks-blue-primary: #173f6e;
  --masks-blue-medium: #1e528f;
  --masks-blue-light: #3da7db;
  --masks-blue-accent: #58a4fc;

  --masks-gold: #ffeb98;
  --masks-gold-dark: #e7a345;

  /* --- Label Colors (Masks RPG stats) --- */
  --masks-danger-color: #e05252;
  --masks-freak-color: #9b59b6;
  --masks-savior-color: #3498db;
  --masks-superior-color: #f39c12;
  --masks-mundane-color: #27ae60;
  --masks-soldier-color: #8b4513;

  /* Semi-transparent versions for backgrounds */
  --masks-danger-bg: rgba(224, 82, 82, 0.15);
  --masks-freak-bg: rgba(155, 89, 182, 0.15);
  --masks-savior-bg: rgba(52, 152, 219, 0.15);
  --masks-superior-bg: rgba(243, 156, 18, 0.15);
  --masks-mundane-bg: rgba(39, 174, 96, 0.15);
  --masks-soldier-bg: rgba(139, 69, 19, 0.15);

  /* --- Semantic Colors --- */
  --masks-text-primary: #ffffff;
  --masks-text-secondary: rgba(255, 255, 255, 0.75);
  --masks-text-muted: rgba(255, 255, 255, 0.5);
  --masks-text-dark: #000000;

  --masks-bg-panel: rgba(20, 30, 45, 0.95);
  --masks-bg-sidebar: rgba(30, 40, 55, 0.92);
  --masks-bg-tab: rgba(40, 50, 65, 0.9);
  --masks-bg-tab-active: rgba(60, 75, 95, 0.95);
  --masks-bg-input: rgba(0, 0, 0, 0.3);
  --masks-bg-input-light: rgba(255, 255, 255, 0.75);

  --masks-border-color: rgba(255, 255, 255, 0.15);
  --masks-border-accent: rgba(61, 167, 219, 0.5);

  /* --- Interactive Elements --- */
  --masks-interactive-bg: #1e528f;
  --masks-interactive-hover: #173f6e;
  --masks-accent: #3da7db;

  /* --- Sheet Background --- */
  --masks-gradient: linear-gradient(to bottom, #58a4fc 0%, #b0c2b8 80%, #fff1b6 100%);
  --masks-window-bg: url("/modules/masks-newgeneration-unofficial/images/skyline.webp"), var(--masks-gradient);

  /* --- Layout Constants --- */
  --masks-corner-radius: 2px;
  --masks-transition-fast: 150ms ease;
  --masks-transition-smooth: 300ms ease;

  /* --- Turn Cards Theme (now uses blue scheme) --- */
  --tc-border-outer: var(--masks-blue-dark);
  --tc-border-inner: var(--masks-blue-primary);
  --tc-frame-bg: var(--masks-bg-panel);
  --tc-nameplate-bg: var(--masks-blue-primary);
  --tc-hover-inner: var(--masks-blue-medium);
  --tc-action-bg: var(--masks-mundane-color);
  --tc-cooldown-bar: var(--masks-blue-light);
  --tc-cooldown-label-bg: rgba(0, 0, 0, 0.72);
  --tc-downed-bg: rgba(104, 59, 71, 0.92);
  --tc-potential-fill: var(--masks-gold-dark);
  --tc-forward-bg: var(--masks-blue-light);
  --tc-pentagon-color: var(--masks-blue-dark);
  --tc-cooldown-opacity: 0.75;
  --tc-downed-opacity: 0.45;
  --tc-notch: rgba(0, 0, 0, 0.12);

  /* --- Legacy compatibility (maps to new system) --- */
  --masks-input-bg-color: var(--masks-bg-input-light);
  --masks-input-border-color: rgba(0, 0, 0, 0.75);
  --masks-input-text-color: var(--masks-text-dark);
  --masks-input-placeholder-color: #979797;
  --masks-input-disabled-color: var(--masks-blue-dark);
  --masks-header-bg-color: var(--masks-blue-primary);
  --masks-cell-title-border-color: var(--masks-blue-primary);
  --masks-bio-title-border-color: var(--masks-blue-light);
  --masks-title-text-color: var(--masks-blue-primary);
  --masks-tabs-border-color: var(--masks-gold);
  --masks-tab-bg-active-color: var(--masks-gold);
  --masks-influence-icon-color: invert(100%);
  --masks-influence-icon-disabled-color: invert(100%) opacity(50%);
}

/* =============================================================================
   BASE STYLES - PbtA Sheet Foundation
   ============================================================================= */

.pbta.window-app {
  .window-content {
    color: var(--masks-text-dark);
    padding: 0;

    a.content-link, a.inline-roll {
      // color: var(--masks-input-text-color);
      background: rgba(0,0,0,0.25);
      color: inherit;
    }
  }

  input, button, select, textarea {
    background: var(--masks-input-bg-color);
    color: var(--masks-input-text-color);
    border: 0.5px solid var(--masks-input-border-color);
    accent-color: var(--masks-tab-bg-active-color);
    font-weight: bold;
  }

  input:disabled, button:disabled, select:disabled, textarea:disabled {
    background: rgba(153, 153, 153, 0.25);
    // color: var(--masks-input-disabled-color);
    color: var(--masks-text-secondary);
  }

  input::placeholder {
    color: var(--masks-input-placeholder-color) !important;
  }
}

/* =============================================================================
   ACTOR SHEET - Main character sheet styling
   ============================================================================= */

.pbta.sheet {
  .advancement { display: none; }
  .sheet-header__fields .adv-tab { display: none; }

  .cell__title.warning {
    background-color: #d68888;
    color: #000000;
    &::before { height: 0px; background-color: none; }
    &::after { width: 0px; background-color: none; }
  }

  .cell--influences,
  .cell--relationshipQuestions,
  .cell--adv-tab,
  .cell--advancements,
  .cell--later-advances {
    margin-top: 10px;
  }

  .cell--momentOfTruth label div.moment-unlock {
    font-style: italic;
    text-transform: capitalize;
    font-size: 15px;
    display: flex;
    align-items: center;
  }

  .sheet-header, .sheet-body {
    padding-left: 10px;
    padding-right: 10px;
  }

  .sheet-look .cell--influence { display: none; }
  .sheet-main .cell--equipment { display: none; }

  input::placeholder,
  .sheet-header select.charplaybook:has(option[value=""]:checked),
  .sheet-header select.charplaybook option[value=""] {
    color: var(--masks-input-placeholder-color);
    font-style: italic;
  }

  &.item {
    input[type=checkbox], input[type=radio] {
      vertical-align: middle;
      position: relative;
      bottom: 1px;
      height: 15px;
    }
    label { color: var(--masks-text-dark); }
  }

  .cell--image {
    border: 1px solid var(--masks-cell-title-border-color);

    .labels-graph-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 10px;
      padding: 4px;
      cursor: help;

      .labels-graph-svg {
        width: 80px;
        height: 80px;
        display: block;
      }
    }
  }

  .window-header {
    background-color: var(--masks-interactive-bg);
  }

  .sheet-resources {
    align-items: start;
    .cell { text-align: left; }
    .cell > .cell__title { justify-content: start; }

    .cell--ongoing .resource-control,
    .cell--forward .resource-control,
    .cell--roll-formula .resource-control {
      border: 0.5px solid var(--masks-input-border-color);
      background: #ffffff;
    }
  }

  .cell__checkboxes, .cell__radio {
    margin: 0;
    & label.flexrow { margin: 0 0 5px 0; }
  }

  .window-content {
    background-image: var(--masks-window-bg);
    background-position: bottom left;
    background-repeat: repeat-x;
    background-size: auto;
  }

  .tox.tox-tinymce .tox-edit-area__iframe {
    background: rgba(255, 255, 255, 0.5);
  }

  .sheet-header__fields { width: 100%; }

  /* --- Influences Section --- */
  .cell--influences {
    .cell__title .item-group-label { cursor: pointer; }

    .item-details-toggle {
      display: inline-block;
      width: 24px;
      height: 16px;
      text-align: center;
      border-radius: 5px;
      transition: all ease-in-out 0.25s;
    }

    .fas { transition: all ease-in-out 0.25s; }
    .open .fas { transform: rotate(180deg); }

    .influence-name {
      flex: 2;
      display: flex;
      gap: 2px;
    }

    input.influence--name {
      width: calc(100% - 36px);
      font-size: 18px;
      text-align: left;
      height: 32px;
      margin: 0px 0px 8px 0px;
    }

    .influence-management {
      margin: 0px 0px 8px 0px;
      display: flex;
      flex-direction: row;
      text-align: center;
      flex: 1;

      .influence-disabled {
        filter: var(--masks-influence-icon-disabled-color);
      }
    }

    img.influence-icon {
      flex: 1;
      vertical-align: top;
      border: 0;
      height: 32px;
      width: 32px;
      padding: 0;
      margin: 0;
      border-radius: 0;
      filter: var(--masks-influence-icon-color);
    }
  }

  & .cell--influences .influence-management .influence-control.influence-delete,
  & .cell--influences .influence-management .influence-control.influence-lock,
  & .cell--influences .influence-management .influence-control.influence-unlock {
    font-size: 32px;
    flex: 1;
  }

  .editor-content {
    background: var(--masks-input-bg-color);
    color: var(--masks-input-text-color);
    border: 0.5px solid var(--masks-input-border-color);
    min-height: 31px;
    padding: 5px;

    a.content-link, a.inline-roll {
      background: var(--masks-input-bg-color);
      border: 0.5px solid var(--masks-input-border-color);
    }
  }

  /* --- Sheet Layout --- */
  .sheet-wrapper {
    .sheet-bottom { padding: 0px 10px; }
    .sheet-top .sheet-attributes-top { padding: 10px; }
    .sheet-top .sheet-attributes-top .cell--attributes-top > .cell + .cell::before {
      left: 0;
      width: 0;
      background: none;
    }

    .sheet-header {
      background-color: var(--masks-header-bg-color);
    }

    .editor-content {
      background: var(--masks-input-bg-color);
      color: var(--masks-input-text-color);
      border: 0.5px solid var(--masks-input-border-color);
      min-height: 31px;
      padding: 0 10px;
    }

    .sheet-bottom {
      .cell--LongText,
      .cell--ListMany,
      .cell--moves,
      .cell--xp,
      .cell--Text,
      .cell--Checkbox,
      .cell--Number {
        padding-top: 5px;
      }

      .cell--conditions { padding-top: 0px; }

      .description {
        .sheet-tab {
          display: flex;
          flex-flow: row wrap;
          justify-content: space-between;
          align-content: flex-start;
          gap: 10px;
        }

        .cell.cell--bio {
          min-height: 175px;
          margin-bottom: 5px;
          width: 48%;

          &:nth-child(3), &:nth-child(4) { width: 100%; }

          .editor {
            min-height: calc(100% - 40px);
            .editor-content { height: 145px; }
          }
        }
      }
    }
  }

  .cell__wrapper {
    position: relative;
    width: 100%;

    & > input[type="number"] {
      font-size: 18px;
      text-align: center;
      background-color: var(--masks-input-bg-color);
      color: var(--masks-input-text-color);
      font-weight: bold;
      margin: 0;
      display: block;
      width: 100%;
    }
  }

  /* --- Stats/Labels Section --- */
  .sheet-attributes {
    position: relative;
    padding-top: 8px;
    padding-left: 8px;
    padding-right: 8px;

    .cell--stats .stat {
      background: var(--masks-interactive-bg);
      color: var(--masks-text-primary);

      .cell__title { color: var(--masks-text-primary); }
      &:hover { background: var(--masks-interactive-hover); }
      .stat-value { border: 1px solid rgba(229, 222, 210, 0.37); }
    }
  }

  /* --- Styled Section Titles --- */
  .bio_style {
    font-style: italic;
    position: relative;
    padding-left: 8px;
    border-bottom: none;
    color: var(--masks-text-dark);
    letter-spacing: 0.05rem;
    font-size: 22px;
    font-weight: normal;
    margin: 10px 10px 0px 0px;

    &::before {
      content: "";
      position: absolute;
      left: 7px;
      top: 0;
      height: 2px;
      width: calc(100% - 10px);
      background-color: var(--masks-bio-title-border-color);
      transform: skewX(-15deg);
    }

    &::after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: var(--masks-bio-title-border-color);
      transform: skewX(-15deg);
    }
  }

  .cell__title {
    font-style: italic;
    font-weight: bold;
    text-transform: uppercase;
    position: relative;
    padding-left: 8px;
    border-bottom: none;
    color: var(--masks-title-text-color);
    letter-spacing: 0.05rem;
    font-size: 22px;

    &::before {
      content: "";
      position: absolute;
      left: 7px;
      top: 0;
      height: 2px;
      width: calc(100% - 10px);
      background-color: var(--masks-cell-title-border-color);
      transform: skewX(-15deg);
    }

    &::after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background-color: var(--masks-cell-title-border-color);
      transform: skewX(-15deg);
    }
  }

  /* --- Tabs --- */
  .tabs {
    border-bottom: 2px solid var(--masks-tabs-border-color);
  }

  .sheet-tabs.tabs > a.item {
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    font-style: italic;
    background-color: var(--masks-interactive-bg);
    color: var(--masks-text-primary);

    &.active, &.active:hover {
      background-color: var(--masks-tab-bg-active-color);
      color: var(--masks-text-dark);
    }

    &:hover, &:focus {
      background-color: var(--masks-interactive-hover);
      color: var(--masks-text-primary);
      font-weight: bold;
    }
  }

  .sheet-header__fields .view-playbook {
    background: var(--masks-tab-bg-active-color);
    color: var(--masks-text-dark);
    opacity: 1;
    border: 0.5px solid var(--masks-interactive-hover);

    &:hover {
      opacity: 1;
      background: var(--masks-interactive-hover);
    }
  }

  /* --- Playbook-specific Customizations --- */
  .cell--theReformed {
    input[type="checkbox"] {
      margin: 3px 1px;
      flex: 0 0 14px;
    }
    .cell__title { font-size: 20px; }
  }

  .cell--theScionGreatestEnemy,
  .cell--theScionGreatestVictim,
  .cell--theScionPersonalIdol,
  .cell--theScionGreatestLeader,
  .cell--theScionGreatestHero,
  .cell--theScionBiggestCelebrity {
    input[type="checkbox"] {
      margin: 3px 1px;
      flex: 0 0 14px;
    }
    .cell__title { font-size: 20px; }

    input[type="checkbox"] {
      &:nth-child(5n) {
        margin-left: 5px;
        &::before {
          display: inline-block;
          content: "";
          border-left: 2px solid #7a7971;
          height: 18px;
          margin: 0 -4px;
        }
      }
    }
  }

  .cell--Checkbox label {
    display: flex;
    align-items: center;
  }
}

/* =============================================================================
   NPC SHEETS
   ============================================================================= */

.pbta.sheet.npc {
  .sheet-main [data-tab=equipment] { display: none; }

  .sheet-wrapper {
    max-height: none;

    .sheet-header {
      background: none;
      margin-bottom: 10px;
      padding: 8px;
      max-height: none;
    }
  }

  .sheet-attributes {
    grid-column: span 5;
    grid-template-columns: repeat(5, minmax(0, 1fr));

    .cell-npc-text {
      grid-column: span 2;
      .editor {
        min-height: 150px;
        max-height: 150px;
      }
    }
  }

  .sheet-header__fields { padding: 0px; }

  .cell--aesthetics .cell--conditions ul.cell__checkboxes label {
    display: flex;
    align-items: center;
  }

  .sheet-attributes .cell-npc-text .editor .tox-editor-container {
    min-height: 150px;
    height: 100% !important;
  }
}

/* =============================================================================
   ITEM SHEETS
   ============================================================================= */

.pbta.sheet.item.playbook {
  min-height: 600px;
  min-width: 800px;
}

.pbta.sheet .editor-content {
  .playbook {
    padding: 10px;

    h1 {
      width: 100%;
      text-align-last: center;
    }

    h2 {
      font-style: italic;
      position: relative;
      padding-left: 8px;
      color: var(--masks-input-text-color);
      letter-spacing: 0.05rem;
      font-size: 22px;

      &::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 0;
        height: 2px;
        width: calc(100% - 10px);
        background-color: var(--masks-cell-title-border-color);
        transform: skewX(-15deg);
      }

      &::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background-color: var(--masks-cell-title-border-color);
        transform: skewX(-15deg);
      }
    }

    h1, h2, h3 { border-bottom: none; }
    h2, h3 { margin-top: 30px; }

    .special {
      color: #ae0000;
      font-weight: bold;
    }

    .rules {
      display: flex;
      flex-flow: wrap;
      justify-content: space-between;
      align-content: flex-start;
      align-items: flex-start;
      gap: 10px 20px;

      div {
        width: 48%;
        h2:nth-child(1) { margin-top: 10px; }
      }
    }

    .extras { margin-top: 30px; }
  }
}

/* =============================================================================
   X-CARD SAFETY TOOL
   ============================================================================= */

#xcard-btn-wrapper {
  display: inline-flex;
  align-items: center;
  margin: 0;
}

#xcard.ui-control.icon {
  transition: var(--ui-fade-delay);
}

#xcard.ui-control.icon:hover {
  background-color: var(--color-level-error);
}

/* =============================================================================
   TEAM POOL HUD (Standalone, outside combat)
   ============================================================================= */

#masks-team {
  width: 100%;
  display: flex;
  justify-content: center;
  pointer-events: none;
  z-index: 100;
  margin: 0.25rem 0;

  .panel {
    pointer-events: auto;
    display: inline-flex;
    align-items: start;
    gap: 8px;
    padding: 12px;
    background: transparent;
    border: none;
    box-shadow: none;
    color: var(--masks-text-primary);
  }

  .tag {
    height: 100%;
    margin: 0;
    color: var(--masks-text-primary);
    background: var(--masks-interactive-bg);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 700;
    text-transform: uppercase;
    font-style: italic;
    letter-spacing: 0.03em;
    font-size: 20px;
  }

  input[name="team"] {
    max-width: 3.6rem;
    text-align: center;
  }
}

/* =============================================================================
   SCENE CONTROLS - Influence Tools
   ============================================================================= */

#scene-controls-tools {
  [data-tool="influenceGainOverThem"] { background-color: #4CAF50; }
  [data-tool="influenceMutual"] { background-color: #2196F3; }
  [data-tool="influenceGiveThemOverYou"] { background-color: #9C27B0; }
  [data-tool="influenceClear"] { background-color: #F44336; }

  [data-tool="forwardAdd"],
  [data-tool="ongoingAdd"],
  [data-tool="forwardRemove"],
  [data-tool="ongoingRemove"] {
    background-color: var(--masks-interactive-bg);
  }
}

.sheet .influence-management {
  img[data-influence-action="hasInfluenceOver"] { filter: #9C27B0 !important; }
  img[data-influence-action="haveInfluenceOver"] { filter: #4CAF50 !important; }
  [data-influence-action="delete"] { color: #F44336; }
}

/* =============================================================================
   COMBAT TRACKER OVERLAY
   ============================================================================= */

#combat {
  li.combatant {
    position: relative;

    > .pbta-gone-toggle {
      position: absolute;
      left: 4px;
      top: 4px;
      z-index: 2;
      opacity: 0;
      transition: var(--ui-fade-delay);
      width: 55px;
      height: 55px;
      font-size: 65px;
      background-color: transparent;
      color: var(--color-level-success-bg);
    }

    &:hover > .pbta-gone-toggle { opacity: 0.4; }
    > .pbta-gone-toggle:focus { opacity: 0.4; }
  }
}

/* =============================================================================
   CHAT CUSTOMIZATIONS
   ============================================================================= */

#chat h4 {
  font-size: var(--font-size-13);
  line-height: 1.25;
  margin-bottom: 4px;
}

.pbta.sheet .cell--moves .item-name,
.pbta.sheet .cell--basic-moves .item-name,
.pbta.sheet .cell--starting-moves .item-name,
.pbta.sheet .cell--advanced-moves .item-name,
.pbta.sheet .cell--special-moves .item-name,
.pbta.sheet .cell--other-moves .item-name,
.pbta.sheet .cell--equipment .item-name,
.pbta.sheet .cell--spells .item-name {
  font-weight: normal;
  text-transform: none !important;
}

.tox.tox-tinymce { min-height: 300px; }

.vtt #chat .message .shift.up { color: forestgreen; }
.vtt #chat .message .shift.down { color: #b00020; }

.cell.look { display: none; }
.cell.abilities { width: 100%; }

[data-edit="system.details.abilities.value"] { min-height: 150px; }
[data-edit="system.details.backstory.value"],
[data-edit="system.details.biography.value"] { min-height: 400px; }

.pbta.sheet.actor { min-height: 80vh; }
.sheet-bottom.flexrow { gap: 0; }
#worldStylesheet .cm-editor { max-height: 300px; }
.sheet-bottom > .sheet-look { min-width: 250px; }
.token-initiative { display: none !important; }
#hotbar { display: none; }

/* =============================================================================
   TURN CARDS HUD - Blue Theme (matches character sheet)
   ============================================================================= */

#masks-turncards {
  /* Layout */
  --tc-max-cols: 8;
  --tc-gap: 8px;
  --tc-card-width: clamp(104px, 7.8vw, 130px);
  --tc-card-aspect: 3 / 4;
  --tc-control-size: 28px;
  --tc-forward-size: 24px;
  --tc-nameplate-height: 32px;
  --tc-status-bar-height: 26px;
  --tc-portrait-pad: 3px;

  /* Motion */
  --tc-transition-fast: 150ms ease-out;
  --tc-transition-smooth: 400ms cubic-bezier(0.4, 0, 0.2, 1);
  --tc-transition-bar: 800ms cubic-bezier(0.25, 0.1, 0.25, 1);

  width: 100%;
  pointer-events: none;
  z-index: 101;
  padding: 0;

  .turncards-row {
    pointer-events: none;
    display: flex;
    flex-wrap: wrap-reverse;
    gap: var(--tc-gap);
    justify-content: center;
    align-items: flex-end;
    width: 100%;
    max-width: calc((var(--tc-card-width) + var(--tc-gap)) * 8 - var(--tc-gap));
    margin: 0 auto;
    padding: 8px 12px;
  }

  .turncard {
    pointer-events: auto;
    box-sizing: border-box;
    flex: 0 0 var(--tc-card-width);
    width: var(--tc-card-width);
    aspect-ratio: var(--tc-card-aspect);
    position: relative;
    border-radius: 1px;
    background: var(--tc-frame-bg);
    border: 2px solid var(--tc-border-outer);
    box-shadow: 0 0 0 2px var(--tc-border-inner) inset, 0 2px 10px rgba(0, 0, 0, 0.35);
    overflow: hidden;
    cursor: pointer;
    transition: transform var(--tc-transition-fast), box-shadow var(--tc-transition-fast), filter var(--tc-transition-fast);

    &:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 0 0 2px var(--tc-hover-inner) inset, 0 10px 26px rgba(0, 0, 0, 0.45);
    }

    &:focus-visible {
      outline: 2px solid var(--color-focus-primary, #7a99ff);
      outline-offset: 2px;
    }

    &.turncard--team {
      cursor: default;
      &:hover {
        transform: none;
        box-shadow: 0 0 0 2px var(--tc-border-inner) inset, 0 2px 10px rgba(0, 0, 0, 0.35);
      }
    }

    &.is-cooldown .turncard__content { opacity: var(--tc-cooldown-opacity); }
    &.is-downed .turncard__content { opacity: var(--tc-downed-opacity); }
    &.is-downed .turncard__portrait img { filter: grayscale(1); }
  }

  .turncard__content {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    transition: opacity var(--tc-transition-smooth);
  }

  .turncard__portrait {
    position: relative;
    flex: 1 1 auto;
    background: var(--tc-frame-bg);
    overflow: hidden;

    img {
      box-sizing: border-box;
      margin: 0;
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: top center;
      transition: filter var(--tc-transition-smooth);
    }
  }

  .turncard__portrait--team {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2px;
    background: linear-gradient(180deg, var(--masks-blue-medium) 0%, var(--masks-blue-dark) 100%);
  }

  /* --- Status Bar --- */
  .turncard__status-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: var(--tc-status-bar-height);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    z-index: 3;
  }

  .turncard__status-bar--cooldown { background: var(--tc-cooldown-label-bg); }
  .turncard__status-bar--downed { background: var(--tc-downed-bg); }
  .turncard__status-bar--ready { background: transparent; }

  .turncard__cooldown-bar {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: calc(var(--cooldown-frac, 0) * 100%);
    background: var(--tc-cooldown-bar);
    opacity: 0.7;
    transition: width var(--tc-transition-bar);
    z-index: 1;
  }

  .turncard__status-bar--downed .turncard__cooldown-bar { opacity: 0.7; }

  .turncard__status-label {
    position: relative;
    z-index: 2;
    font-size: 0.65rem;
    font-weight: 900;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.92);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.55);
    white-space: nowrap;
  }

  .turncard__status-bar--ready .turncard__status-label { opacity: 0; }

  /* --- Action Overlay --- */
  .turncard__action {
    box-sizing: border-box;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: var(--tc-status-bar-height);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--tc-action-bg);
    border: none;
    border-radius: 0;
    width: auto;
    padding: 0 8px;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transform: translateY(-4px);
    z-index: 4;
    transition: opacity var(--tc-transition-fast), transform var(--tc-transition-fast), filter var(--tc-transition-fast);

    &:hover:not(:disabled) { filter: brightness(1.05); }
    &:disabled {
      filter: grayscale(0.6) brightness(0.8);
      cursor: not-allowed;
    }

    .turncard__action-label {
      font-size: 0.7rem;
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.95);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }
  }

  .turncard:hover .turncard__action,
  .turncard:focus-within .turncard__action {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /* --- Nameplate --- */
  .turncard__nameplate {
    box-sizing: border-box;
    position: relative;
    flex: 0 0 auto;
    height: var(--tc-nameplate-height);
    padding: 4px 6px;
    background: var(--tc-nameplate-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;

    &::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 0;
      background: linear-gradient(135deg, transparent 75% 55%, var(--tc-notch) 55% 100%);
      pointer-events: none;
    }
  }

  .turncard__name {
    position: relative;
    z-index: 1;
    text-transform: uppercase;
    font-weight: 900;
    font-size: 1rem;
    letter-spacing: 0.03em;
    color: var(--masks-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  /* --- Corner Controls --- */
  .turncard__shift,
  .turncard__forward,
  .turncard__potential {
    box-sizing: border-box;
    position: absolute;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 5;
    transition: transform var(--tc-transition-fast), filter var(--tc-transition-fast), opacity var(--tc-transition-fast);
    border-radius: 50%;

    &:hover:not(:disabled) {
      transform: scale(1.15);
      filter: brightness(1.12);
    }

    &:active:not(:disabled) { transform: scale(0.95); }

    &.is-disabled, &:disabled {
      opacity: 1;
      cursor: default;
      &:hover { transform: none; filter: none; }
    }
  }

  .turncard__shift {
    width: var(--tc-control-size);
    height: var(--tc-control-size);
    min-width: var(--tc-control-size);
    min-height: var(--tc-control-size);
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    background: rgba(0, 0, 0, 0.55);
    border: 1px solid rgba(255, 255, 255, 0.85);
  }

  .turncard__labels-graph {
    --labels-size: 40px;
    border-radius: 0;
    clip-path: polygon(50% 0%, 100% 38%, 81% 100%, 19% 100%, 0% 38%);
    left: 2px;
    bottom: 2px;
    width: var(--labels-size);
    height: var(--labels-size);
    min-width: var(--labels-size);
    min-height: var(--labels-size);
    max-width: var(--labels-size);
    max-height: var(--labels-size);
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    z-index: 6;
    background: transparent;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;

    .labels-graph-svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    &:hover:not(:disabled) {
      transform: scale(1.2);
      filter: brightness(1.15);
    }

    &:active:not(:disabled) { transform: scale(1.05); }

    &.is-disabled, &:disabled {
      opacity: 1;
      cursor: default;
      &:hover { transform: none; filter: none; }
    }
  }

  .turncard__forward {
    width: var(--tc-forward-size);
    height: var(--tc-forward-size);
    min-width: var(--tc-forward-size);
    min-height: var(--tc-forward-size);
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    font-size: 0.75rem;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid transparent;
    color: #fff;

    .turncard__forward-value {
      font-size: 0.7rem;
      font-weight: 900;
      line-height: 1;
    }

    i { font-size: 0.65rem; line-height: 1; }

    &.has-bonus {
      background: var(--tc-forward-bg);
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.92);
    }

    &.has-negative {
      background: var(--masks-danger-color);
      box-shadow: 0 2px 6px rgba(224, 82, 82, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.92);
    }
  }

  .turncard__potential {
    width: var(--tc-control-size);
    height: var(--tc-control-size);
    min-width: var(--tc-control-size);
    min-height: var(--tc-control-size);
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    background: var(--tc-pentagon-color);
    border: 1px solid rgba(255, 255, 255, 0.92);
    overflow: hidden;

    &::before {
      content: "";
      position: absolute;
      inset: auto 0 0 0;
      height: var(--potential-fill, 0%);
      background: var(--tc-potential-fill);
      transition: height var(--tc-transition-smooth);
    }

    i {
      position: relative;
      z-index: 1;
      color: #fff;
      font-size: 0.75rem;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    &.is-bump { animation: tc-bump 200ms ease-out; }
  }

  /* --- Team Card Internals --- */
  .turncard__team {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
  }

  .turncard__team-label {
    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
  }

  .turncard__team-value {
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 0.04em;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
    line-height: 1;
  }

  .turncard__team-controls {
    display: flex;
    gap: 2px;
    flex-wrap: nowrap;
    justify-content: space-evenly;
  }

  .turncard__team-btn {
    box-sizing: border-box;
    width: calc(var(--tc-control-size) - 2px);
    height: calc(var(--tc-control-size) - 2px);
    padding: 0;
    border-radius: 3px;
    border: 2px solid rgba(255, 255, 255, 0.55);
    background: rgba(0, 0, 0, 0.25);
    color: #fff;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background-color var(--tc-transition-fast), transform var(--tc-transition-fast), border-color var(--tc-transition-fast);

    &:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.18);
      border-color: rgba(255, 255, 255, 0.85);
      transform: scale(1.08);
    }

    &:active:not(:disabled) { transform: scale(0.95); }

    &:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      &:hover {
        background: rgba(0, 0, 0, 0.25);
        transform: none;
        border-color: rgba(255, 255, 255, 0.55);
      }
    }

    i { font-size: 0.75rem; }
  }

  /* --- Control Columns (Flexbox) --- */
  .turncard__controls {
    position: absolute;
    bottom: 0px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    gap: 2px;
    z-index: 5;
    pointer-events: none;

    > * {
      pointer-events: auto;
      flex: 0 0 auto; /* Prevent buttons from stretching */
    }
  }

  .turncard__controls--left {
    left: 0;
    bottom: 0;
  }

  .turncard__controls--right {
    right: 4px;
    bottom: 4px;
  }

  /* Update existing controls to work in flexbox */
  .turncard__controls .turncard__shift,
  .turncard__controls .turncard__forward,
  .turncard__controls .turncard__potential,
  .turncard__controls .turncard__tracker {
    position: relative;
    left: auto;
    right: auto;
    bottom: auto;
    flex: 0 0 auto; /* Ensure buttons don't stretch */
  }

  /* Shift Labels row - horizontal layout for pentagon + beside trackers */
  .turncard__shift-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 2px;
    flex: 0 0 auto;
  }

  /* --- Playbook Resource Trackers --- */
  /* Large colored icons with semi-opaque background */
  .turncard__tracker {
    box-sizing: border-box;
    position: relative;
    width: var(--tc-control-size);
    height: var(--tc-control-size);
    min-width: var(--tc-control-size);
    min-height: var(--tc-control-size);
    max-width: var(--tc-control-size);
    max-height: var(--tc-control-size);
    aspect-ratio: 1 / 1;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.45);
    border: none;
    color: var(--tracker-color, #888);
    font-size: 1.25rem;
    font-weight: 700;
    overflow: visible;
    flex: 0 0 auto;
    transition: transform var(--tc-transition-fast), filter var(--tc-transition-fast), opacity var(--tc-transition-fast), background var(--tc-transition-fast);

    /* The icon - large and colored */
    i {
      font-size: 1.1rem;
      color: var(--tracker-color, #888);
      transition: transform var(--tc-transition-fast), filter var(--tc-transition-fast);
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
      line-height: 1;
    }

    /* Value badge for numeric/display trackers with counts */
    .turncard__tracker-badge {
      position: absolute;
      bottom: -3px;
      right: -3px;
      min-width: 14px;
      height: 14px;
      padding: 0 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 7px;
      color: #fff;
      font-size: 0.6rem;
      font-weight: 700;
      text-shadow: none;
      z-index: 10;
      line-height: 1;
    }

    &:hover:not(:disabled) {
      transform: scale(1.15);
      background: rgba(0, 0, 0, 0.6);
      i { filter: brightness(1.25) drop-shadow(0 0 4px var(--tracker-color, #888)); }
    }

    &:active:not(:disabled) { transform: scale(0.92); }

    &.is-display {
      cursor: default;
      opacity: 0.85;
      &:hover { transform: none; background: rgba(0, 0, 0, 0.45); i { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5)); } }
    }

    &.is-action {
      cursor: pointer;
      &:hover:not(:disabled) {
        transform: scale(1.15);
        i { filter: brightness(1.3) drop-shadow(0 0 6px var(--tracker-color, #888)); }
      }
    }

    &.is-editable {
      cursor: pointer;
    }

    &.is-bump { animation: tc-bump 200ms ease-out; }

    &:disabled {
      cursor: default;
      opacity: 0.5;
      &:hover { transform: none; background: rgba(0, 0, 0, 0.45); }
    }
  }

  /* Fillable trackers with fill effect (numeric and display with fillable flag) */
  .turncard__tracker--fillable {
    /* NOTE: overflow must be visible so the badge doesn't get clipped */
    overflow: visible;

    /* Filled portion overlays the icon - uses clip-path for fill effect */
    .turncard__tracker-fill {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      clip-path: inset(calc(100% - var(--tracker-fill, 0%)) 0 0 0);
      transition: clip-path var(--tc-transition-smooth);
      background: var(--tracker-color, #888);
      border-radius: 50%;
      pointer-events: none; /* Don't block clicks on the button */

      i {
        font-size: 1.1rem;
        color: #fff;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.5));
      }
    }

    /* Ensure badge stays above the fill */
    .turncard__tracker-badge {
      z-index: 15;
    }
  }

  /* Beside tracker (Soldier - to the right of Shift Labels) */
  .turncard__tracker--beside {
    --beside-size: calc(var(--tc-control-size) - 4px);
    width: var(--beside-size);
    height: var(--beside-size);
    min-width: var(--beside-size);
    min-height: var(--beside-size);
    max-width: var(--beside-size);
    max-height: var(--beside-size);
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;

    i {
      font-size: 0.85rem;
      line-height: 1;
    }
    .turncard__tracker-badge {
      font-size: 0.5rem;
      min-width: 12px;
      height: 12px;
      bottom: -2px;
      right: -2px;
    }
  }

  /* Playbook-specific tracker color themes */
  .turncard__tracker--doom {
    --tracker-color: #9333ea;
    i { filter: drop-shadow(0 0 6px rgba(147, 51, 234, 0.6)); }
  }

  .turncard__tracker--burn {
    --tracker-color: #f97316;
    i { filter: drop-shadow(0 0 8px rgba(249, 115, 22, 0.7)); }
    &:hover i { filter: drop-shadow(0 0 12px rgba(249, 115, 22, 0.9)) brightness(1.2); }
  }

  .turncard__tracker--gadgets {
    --tracker-color: #059669;
    i { filter: drop-shadow(0 0 5px rgba(5, 150, 105, 0.5)); }
  }

  .turncard__tracker--soldier {
    --tracker-color: #1e40af;
    i { filter: drop-shadow(0 0 5px rgba(30, 64, 175, 0.6)); }
  }

  .turncard__tracker--heart {
    --tracker-color: #dc2626;
    i { filter: drop-shadow(0 0 5px rgba(220, 38, 38, 0.6)); }

    /* Filled state when ongoing > 0 (similar to forward button with bonus) */
    &.has-ongoing {
      background: #dc2626;
      border: 1px solid rgba(255, 255, 255, 0.92);
      box-shadow: 0 2px 6px rgba(220, 38, 38, 0.45);

      i {
        color: #fff;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.5));
      }

      .turncard__tracker-badge {
        background: #fff;
        color: #dc2626;
        font-weight: 600;
      }
    }
  }

  .turncard__tracker--obligations,
  .turncard__tracker--legacy {
    --tracker-color: #0891b2;
    i { filter: drop-shadow(0 0 5px rgba(8, 145, 178, 0.6)); }
  }

  .turncard__tracker--steps {
    --tracker-color: #ec4899;
    i { filter: drop-shadow(0 0 5px rgba(236, 72, 153, 0.6)); }
  }

  .turncard__tracker--drives {
    --tracker-color: #22c55e;
    i { filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.6)); }
  }

  .turncard__tracker--lessons {
    --tracker-color: #8b5cf6;
    i { filter: drop-shadow(0 0 5px rgba(139, 92, 246, 0.6)); }
  }

  .turncard__tracker--audience {
    --tracker-color: #eab308;
    i { filter: drop-shadow(0 0 6px rgba(234, 179, 8, 0.7)); }
  }

  .turncard__tracker--roots {
    --tracker-color: #0d9488;
    i { filter: drop-shadow(0 0 5px rgba(13, 148, 136, 0.6)); }
  }

  .turncard__tracker--dots {
    --tracker-color: #7c3aed;
    i { filter: drop-shadow(0 0 5px rgba(124, 58, 237, 0.6)); }
  }

  .turncard__tracker--respect {
    --tracker-color: #be123c;
    i { filter: drop-shadow(0 0 5px rgba(190, 18, 60, 0.6)); }
  }

  @keyframes tc-bump {
    0% { transform: scale(1); }
    50% { transform: scale(1.25); }
    100% { transform: scale(1); }
  }
}

/* Fallback for browsers without aspect-ratio */
@supports not (aspect-ratio: 1) {
  #masks-turncards .turncard {
    height: calc(var(--tc-card-width) * 4 / 3);
  }
}

/* =============================================================================
   MASKS SHEET V2 - Modern Character Sheet Layout
   ============================================================================= */

.masks-sheet-v2 {
  input:disabled,
button:disabled,
select:disabled,
textarea:disabled {
  color: var(--masks-text-secondary);
}
}

/* Main Sheet Container */
.pbta.sheet.actor .masks-sheet-v2 {
  background: transparent;
}

.masks-sheet-v2 .masks-sheet {
  display: grid;
  grid-template-columns: 280px 1fr;
  height: 100%;
  min-height: 600px;
  gap: 0;
  background: var(--masks-bg-panel);
  border-radius: var(--masks-corner-radius);
  overflow: hidden;
}

/* --- Left Panel --- */
.masks-sheet-v2 .masks-left-panel {
  display: flex;
  flex-direction: column;
  background: linear-gradient(180deg, rgba(20, 30, 45, 0.98) 0%, rgba(15, 25, 40, 0.98) 100%);
  border-right: 1px solid var(--masks-border-color);
  padding: 16px;
  gap: 16px;
}

.masks-sheet-v2 .character-portrait {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: var(--masks-corner-radius);
  overflow: hidden;
  border: 2px solid var(--masks-border-accent);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);

  .profile-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top center;
    cursor: pointer;
    transition: transform var(--masks-transition-smooth);

    &:hover { transform: scale(1.02); }
  }
}

.masks-sheet-v2 .character-identity {
  display: flex;
  flex-direction: column;
  gap: 8px;

  .character-name {
    font-size: 1.5rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--masks-text-primary);
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--masks-border-accent);
    padding: 4px 0;
    width: 100%;

    &::placeholder { color: var(--masks-text-muted); }
    &:focus {
      outline: none;
      border-bottom-color: var(--masks-accent);
    }
  }

  .character-real-name {
    font-size: 1rem;
    font-style: italic;
    color: var(--masks-text-secondary);
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--masks-border-color);
    padding: 4px 0;
    width: 100%;

    &::placeholder {
      color: var(--masks-text-muted);
      font-style: italic;
    }

    &:focus {
      outline: none;
      border-bottom-color: var(--masks-accent);
    }
  }

  .playbook-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 4px;
    min-width: 0;

    .charplaybook {
      flex: 1;
      min-width: 0;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-primary);
      padding: 8px 10px;
      font-size: 0.9rem;
      cursor: pointer;
      height: auto;
      min-height: 36px;

      &:focus {
        outline: none;
        border-color: var(--masks-accent);
      }

      option {
        background: var(--masks-bg-panel);
        color: var(--masks-text-primary);
        padding: 8px;
      }
    }

    .playbook-link {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-muted);
      cursor: pointer;
      transition: all var(--masks-transition-fast);

      &:hover {
        background: var(--masks-accent);
        color: var(--masks-text-primary);
        border-color: var(--masks-accent);
      }

      &.active { color: var(--masks-accent); }
    }
  }
}

/* --- Conditions Panel --- */
.masks-sheet-v2 .conditions-panel {
  .conditions-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--masks-text-muted);
    margin-bottom: 8px;
  }

  .conditions-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .condition-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    color: var(--masks-text-secondary);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all var(--masks-transition-fast);

    i { font-size: 0.75rem; }

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Active condition colors match affected labels */
    &.condition--afraid.active {
      background: rgba(224, 82, 82, 0.7);
      border-color: var(--masks-danger-color);
      color: white;
    }
    &.condition--angry.active {
      background: rgba(39, 174, 96, 0.7);
      border-color: var(--masks-mundane-color);
      color: white;
    }
    &.condition--guilty.active {
      background: rgba(243, 156, 18, 0.7);
      border-color: var(--masks-superior-color);
      color: white;
    }
    &.condition--hopeless.active {
      background: rgba(155, 89, 182, 0.7);
      border-color: var(--masks-freak-color);
      color: white;
    }
    &.condition--insecure.active {
      background: rgba(52, 152, 219, 0.7);
      border-color: var(--masks-savior-color);
      color: white;
    }

    /* Inactive state with color hint */
    &.condition--afraid:not(.active) { border-left: 3px solid var(--masks-danger-color); }
    &.condition--angry:not(.active) { border-left: 3px solid var(--masks-mundane-color); }
    &.condition--guilty:not(.active) { border-left: 3px solid var(--masks-superior-color); }
    &.condition--hopeless:not(.active) { border-left: 3px solid var(--masks-freak-color); }
    &.condition--insecure:not(.active) { border-left: 3px solid var(--masks-savior-color); }
  }
}

/* --- Right Section --- */
.masks-sheet-v2 .masks-sheet__right {
  display: grid;
  grid-template-columns: 1fr 220px;
  height: 100%;
  overflow: hidden;
  position: relative;
}

.masks-sheet-v2 .tabs-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.masks-sheet-v2 .sheet-tabs.tabs {
  display: flex;
  gap: 2px;
  padding: 8px 12px 0;
  background: var(--masks-bg-tab);
  border-bottom: none;

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-radius: var(--masks-corner-radius) var(--masks-corner-radius) 0 0;
    color: var(--masks-text-muted);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all var(--masks-transition-fast);

    i { font-size: 0.9rem; }

    &:hover {
      color: var(--masks-text-secondary);
      background: rgba(255, 255, 255, 0.05);
    }

    &.active {
      color: var(--masks-text-primary);
      background: var(--masks-bg-tab-active);
    }
  }
}

.masks-sheet-v2 .tab-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--masks-bg-tab-active);
  padding: 12px;
  scroll-behavior: smooth;
  overscroll-behavior: contain;

  .tab {
    display: none;
    &.active { display: block; }
  }

  .sheet-tab {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
}

/* --- Section Titles (V2) --- */
.masks-sheet-v2 .section-title,
.masks-sheet-v2 .sidebar-title,
.masks-sheet-v2 .subsection-title {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--masks-text-secondary);
  margin-bottom: 8px;
}

.masks-sheet-v2 .feature-label,
.masks-sheet-v2 .cell__title {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--masks-text-secondary);
  margin-bottom: 8px;
  font-style: normal;
  position: relative;
  padding-left: 0;
  border-bottom: none;

  &::before, &::after { display: none; }
}

.masks-sheet-v2 .section-description {
  font-size: 0.85rem;
  color: var(--masks-text-muted);
  font-style: italic;
  margin-bottom: 8px;
}

.masks-sheet-v2 .editor {
  min-height: 100px;

  .editor-content {
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    color: var(--masks-text-primary);
    padding: 8px;
    min-height: 80px;
  }
}

/* --- Stats Sidebar --- */
.masks-sheet-v2 .stats-sidebar {
  background: var(--masks-bg-sidebar);
  border-left: 1px solid var(--masks-border-color);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow-y: auto;
}

.masks-sheet-v2 .labels-section {
  .labels-graph-clickable {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    cursor: pointer;
    transition: transform var(--masks-transition-fast);

    &:hover { transform: scale(1.05); }

    .labels-graph-svg {
      width: 100px;
      height: 100px;

      path:last-of-type {
        transition: fill 0.3s ease, stroke 0.3s ease, d 0.3s ease;
      }

      &.updating { animation: graph-pulse 0.3s ease; }
    }
  }

  @keyframes graph-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .labels-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .label-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    padding: 6px 8px;
    transition: all var(--masks-transition-fast);

    &:hover { background: rgba(255, 255, 255, 0.05); }

    &.locked {
      opacity: 0.6;
      .label-row-bottom { pointer-events: none; }
    }

    .label-row-top {
      display: flex;
      align-items: center;
      text-align: center;
      padding-left: 4px;
      gap: 6px;
    }

    .label-row-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    /* Label colors */
    &.label--danger {
      border-left: 3px solid var(--masks-danger-color);
      .label-icon { color: var(--masks-danger-color); }
    }
    &.label--freak {
      border-left: 3px solid var(--masks-freak-color);
      .label-icon { color: var(--masks-freak-color); }
    }
    &.label--savior {
      border-left: 3px solid var(--masks-savior-color);
      .label-icon { color: var(--masks-savior-color); }
    }
    &.label--superior {
      border-left: 3px solid var(--masks-superior-color);
      .label-icon { color: var(--masks-superior-color); }
    }
    &.label--mundane {
      border-left: 3px solid var(--masks-mundane-color);
      .label-icon { color: var(--masks-mundane-color); }
    }
    &.label--soldier {
      border-left: 3px solid var(--masks-soldier-color);
      .label-icon { color: var(--masks-soldier-color); }
    }

    .label-icon {
      font-size: 0.85rem;
      width: 16px;
      text-align: center;
      flex-shrink: 0;
    }

    .label-name {
      flex: 1;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--masks-text-primary);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .label-lock {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      padding: 0;
      background: transparent;
      border: none;
      color: var(--masks-text-muted);
      cursor: pointer;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color var(--masks-transition-fast);

      &:hover { color: var(--masks-text-primary); }
    }

    .label-btn {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-secondary);
      cursor: pointer;
      font-size: 0.65rem;
      line-height: 1;
      transition: all var(--masks-transition-fast);

      i {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      &:hover:not(:disabled) {
        background: var(--masks-accent);
        color: white;
        border-color: var(--masks-accent);
      }

      &:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
    }

    .label-value {
      flex-shrink: 0;
      width: 32px;
      text-align: center;
      background: transparent;
      border: none;
      color: var(--masks-text-primary);
      font-size: 1rem;
      font-weight: 700;
      transition: transform 0.2s ease, color 0.2s ease;

      &:focus { outline: none; }

      &::-webkit-outer-spin-button,
      &::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      -moz-appearance: textfield;

      &.shifting-up { animation: label-shift-up 0.3s ease; }
      &.shifting-down { animation: label-shift-down 0.3s ease; }
    }

    @keyframes label-shift-up {
      0% { transform: scale(1); color: var(--masks-text-primary); }
      50% { transform: scale(1.3); color: #4CAF50; }
      100% { transform: scale(1); color: var(--masks-text-primary); }
    }

    @keyframes label-shift-down {
      0% { transform: scale(1); color: var(--masks-text-primary); }
      50% { transform: scale(1.3); color: #F44336; }
      100% { transform: scale(1); color: var(--masks-text-primary); }
    }
  }

  .label-header, .label-controls { display: contents; }
}

/* --- Potential Section --- */
.masks-sheet-v2 .potential-section {
  .potential-tracker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .potential-pips {
    display: flex;
    gap: 4px;

    .potential-pip {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--masks-bg-input);
      border: 2px solid var(--masks-border-color);
      cursor: pointer;
      transition: all var(--masks-transition-fast);

      &:hover {
        border-color: var(--masks-gold-dark);
        transform: scale(1.1);
      }

      &.filled {
        background: var(--masks-gold-dark);
        border-color: var(--masks-gold-dark);
      }
    }
  }

  .potential-count {
    font-size: 0.75rem;
    color: var(--masks-text-muted);
  }
}

/* --- Advantages Section --- */
.masks-sheet-v2 .advantages-section {
  display: flex;
  flex-direction: column;
  gap: 6px;
  overflow: hidden;

  .sidebar-title { margin-bottom: 4px; }
}

.masks-sheet-v2 .modifier-section {
  .modifier-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    padding: 6px 8px;
    transition: all var(--masks-transition-fast);

    &:hover { background: rgba(255, 255, 255, 0.05); }
  }

  .modifier-row-top {
    display: flex;
    align-items: center;
    text-align: center;
    padding: 0 28px 0 4px;
    gap: 6px;
  }

  .modifier-icon {
    font-size: 0.85rem;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
    color: var(--masks-accent);
  }

  .modifier-label {
    flex: 1;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--masks-text-primary);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .modifier-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 4px;

    .modifier-btn {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-secondary);
      cursor: pointer;
      font-size: 0.65rem;
      line-height: 1;
      transition: all var(--masks-transition-fast);

      i {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      &:hover:not(:disabled) {
        background: var(--masks-accent);
        color: white;
        border-color: var(--masks-accent);
      }
    }

    .modifier-value {
      flex-shrink: 0;
      width: 32px;
      text-align: center;
      background: transparent;
      border: none;
      color: var(--masks-text-primary);
      font-size: 1rem;
      font-weight: 700;

      &:focus { outline: none; }

      &::-webkit-outer-spin-button,
      &::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      -moz-appearance: textfield;
    }
  }

  &.modifier--forward {
    .modifier-row { border-left: 3px solid #4CAF50; }
    .modifier-icon { color: #4CAF50; }
  }

  &.modifier--ongoing {
    .modifier-row { border-left: 3px solid #2196F3; }
    .modifier-icon { color: #2196F3; }
  }
}

/* --- Playbook Attributes Section --- */
.masks-sheet-v2 .playbook-attrs-section {
  .playbook-attr {
    margin-bottom: 12px;
    padding: 8px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    border-left: 3px solid var(--masks-freak-color);

    .attr-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--masks-text-primary);
      margin-bottom: 6px;
    }

    .clock-pips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 4px;

      .clock-pip {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--masks-bg-sidebar);
        border: 2px solid var(--masks-freak-color);
        cursor: pointer;
        transition: all var(--masks-transition-fast);

        &:hover {
          transform: scale(1.1);
          box-shadow: 0 0 8px var(--masks-freak-color);
        }
        &.filled {
          background: var(--masks-freak-color);
          border-color: var(--masks-freak-color);
        }
      }
    }

    .clock-count {
      display: block;
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--masks-text-secondary);
    }

    .number-controls {
      display: flex;
      align-items: center;
      gap: 4px;

      .attr-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-secondary);
        cursor: pointer;
        transition: all var(--masks-transition-fast);

        &:hover {
          background: var(--masks-accent);
          color: white;
        }
      }

      input {
        width: 50px;
        text-align: center;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-primary);
        font-weight: 600;

        &:focus {
          outline: none;
          border-color: var(--masks-accent);
        }
      }
    }

    textarea {
      width: 100%;
      min-height: 60px;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-primary);
      padding: 6px;
      font-size: 0.8rem;
      resize: vertical;

      &:focus {
        outline: none;
        border-color: var(--masks-accent);
      }
    }

    .attr-checklist {
      list-style: none;
      padding: 0;
      margin: 0;

      li {
        margin-bottom: 4px;

        label {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 0.8rem;
          color: var(--masks-text-secondary);
          cursor: pointer;

          input[type="checkbox"] { accent-color: var(--masks-accent); }

          input[type="text"] {
            flex: 1;
            background: var(--masks-bg-input);
            border: 1px solid var(--masks-border-color);
            border-radius: var(--masks-corner-radius);
            color: var(--masks-text-primary);
            padding: 2px 6px;
            font-size: 0.8rem;

            &:focus {
              outline: none;
              border-color: var(--masks-accent);
            }
          }
        }
      }
    }
  }
}

/* --- Info Tab --- */
.masks-sheet-v2 .info-tab {
  .info-section {
    margin-bottom: 16px;
    &:last-child { margin-bottom: 0; }
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;

    .section-title {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .influence-create {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--masks-accent);
      border: none;
      border-radius: var(--masks-corner-radius);
      color: white;
      cursor: pointer;
      transition: all var(--masks-transition-fast);

      &:hover {
        transform: scale(1.1);
        filter: brightness(1.1);
      }
    }
  }

  .influences-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .influence-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    transition: opacity var(--masks-transition-fast);

    &.locked {
      opacity: 0.7;
      border-left: 3px solid var(--masks-accent);
      .influence-name-input { cursor: default; }
    }

    .influence-name-row {
      flex: 1;

      .influence-name-input {
        width: 100%;
        background: transparent;
        border: none;
        border-bottom: 1px solid transparent;
        color: var(--masks-text-primary);
        font-size: 0.9rem;
        padding: 2px 0;

        &:focus {
          outline: none;
          border-bottom-color: var(--masks-accent);
        }

        &[readonly] { cursor: default; }
      }
    }

    .influence-controls {
      display: flex;
      gap: 4px;

      .influence-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 2px;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-muted);
        cursor: pointer;
        font-size: 0.55rem;
        line-height: 1;
        transition: all var(--masks-transition-fast);

        i {
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.65rem;
        }

        span { display: none; }

        &:hover:not(:disabled) {
          background: var(--masks-accent);
          color: white;
          border-color: var(--masks-accent);
        }

        &.active {
          background: var(--masks-accent);
          color: white;
          border-color: var(--masks-accent);
        }

        &:disabled {
          opacity: 0.4;
          cursor: not-allowed;
        }

        &.influence-delete-btn:hover:not(:disabled) {
          background: var(--masks-danger-color);
          border-color: var(--masks-danger-color);
        }
      }
    }
  }

  .no-influences {
    font-size: 0.85rem;
    color: var(--masks-text-muted);
    font-style: italic;
    text-align: center;
    padding: 16px;
  }
}

/* --- Powers Tab --- */
.masks-sheet-v2 .powers-tab {
  .powers-modifiers {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);

    .modifier-field {
      display: flex;
      align-items: center;
      gap: 8px;

      label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--masks-text-muted);
        white-space: nowrap;
      }

      input[type="text"] {
        width: 80px;
        background: var(--masks-bg-sidebar);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-primary);
        padding: 4px 8px;
        font-size: 0.85rem;

        &:focus {
          outline: none;
          border-color: var(--masks-accent);
        }
      }

      .modifier-stepper {
        display: flex;
        align-items: center;
        gap: 4px;

        button {
          width: 24px;
          height: 24px;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: var(--masks-bg-sidebar);
          border: 1px solid var(--masks-border-color);
          border-radius: var(--masks-corner-radius);
          color: var(--masks-text-secondary);
          cursor: pointer;
          transition: all var(--masks-transition-fast);

          &:hover {
            background: var(--masks-accent);
            color: white;
            border-color: var(--masks-accent);
          }
        }

        input {
          width: 40px;
          text-align: center;
          background: var(--masks-bg-sidebar);
          border: 1px solid var(--masks-border-color);
          border-radius: var(--masks-corner-radius);
          color: var(--masks-text-primary);
          font-weight: 600;

          &:focus {
            outline: none;
            border-color: var(--masks-accent);
          }
        }
      }
    }
  }

  /* Powers Sections */
  .powers-sections {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .powers-section {
    &__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--masks-border-color);
    }

    &__title {
      margin: 0;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--masks-text-muted);
    }

    &__add {
      width: 24px;
      height: 24px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      color: var(--masks-text-muted);
      cursor: pointer;
      font-size: 0.7rem;
      transition: all var(--masks-transition-fast);

      &:hover {
        background: var(--masks-accent);
        border-color: var(--masks-accent);
        color: white;
      }
    }

    &__cards {
      display: flex;
      flex-direction: column;
    }
  }

  .power-card {
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    border-left: 3px solid var(--masks-text-muted);
    overflow: hidden;
    transition: border-color var(--masks-transition-fast), box-shadow var(--masks-transition-fast);

    /* Label-based border colors */
    &.power-card--danger { border-left-color: var(--masks-danger-color); }
    &.power-card--freak { border-left-color: var(--masks-freak-color); }
    &.power-card--savior { border-left-color: var(--masks-savior-color); }
    &.power-card--superior { border-left-color: var(--masks-superior-color); }
    &.power-card--mundane { border-left-color: var(--masks-mundane-color); }
    &.power-card--prompt { border-left-color: var(--masks-text-muted); }

    /* Hidden radio input */
    .power-card__radio {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Header/label - always visible */
    .power-card__header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 2px;
      padding-right: 8px;
      cursor: pointer;
      transition: background var(--masks-transition-fast);

      &:hover {
        background: rgba(255, 255, 255, 0.03);
      }
    }

    .power-card__icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      background: var(--masks-bg-input);
      object-fit: cover;
      cursor: pointer;
      transition: all var(--masks-transition-fast);

      &:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(61, 167, 219, 0.3);
      }

      &.rollable:hover {
        border-color: var(--masks-accent);
        background: var(--masks-accent);
      }
    }

    .power-card__name {
      flex: 1;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--masks-text-primary);
    }

    /* Name colors based on roll type */
    &.power-card--danger .power-card__name { color: var(--masks-danger-color); }
    &.power-card--freak .power-card__name { color: var(--masks-freak-color); }
    &.power-card--savior .power-card__name { color: var(--masks-savior-color); }
    &.power-card--superior .power-card__name { color: var(--masks-superior-color); }
    &.power-card--mundane .power-card__name { color: var(--masks-mundane-color); }

    .power-card__tag {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: var(--masks-corner-radius);
      background: rgba(255, 255, 255, 0.1);
      color: var(--masks-text-secondary);
      border: 1px solid transparent;

      i { font-size: 0.7rem; }

      &.power-card__tag--prompt {
        background: rgba(255, 255, 255, 0.05);
        color: var(--masks-text-muted);
      }
    }

    /* Tag colors based on roll type */
    &.power-card--danger .power-card__tag {
      background: var(--masks-danger-bg);
      color: var(--masks-danger-color);
      border-color: var(--masks-danger-color);
    }
    &.power-card--freak .power-card__tag {
      background: var(--masks-freak-bg);
      color: var(--masks-freak-color);
      border-color: var(--masks-freak-color);
    }
    &.power-card--savior .power-card__tag {
      background: var(--masks-savior-bg);
      color: var(--masks-savior-color);
      border-color: var(--masks-savior-color);
    }
    &.power-card--superior .power-card__tag {
      background: var(--masks-superior-bg);
      color: var(--masks-superior-color);
      border-color: var(--masks-superior-color);
    }
    &.power-card--mundane .power-card__tag {
      background: var(--masks-mundane-bg);
      color: var(--masks-mundane-color);
      border-color: var(--masks-mundane-color);
    }

    /* Content - hidden by default, shown when radio checked */
    .power-card__content {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.25s ease-out;
    }

    .power-card__inner {
      overflow: hidden;
    }

    /* Expanded state when radio is checked */
    .power-card__radio:checked ~ .power-card__content {
      grid-template-rows: 1fr;
    }

    .power-card__radio:checked ~ .power-card__header {
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid var(--masks-border-color);
    }

    .power-card__description {
      // padding: 12px 12px 8px 54px;
      padding: 8px;
      font-size: 0.85rem;
      color: var(--masks-text-secondary);
      line-height: 1.6;

      p { margin: 0 0 0.5em 0; }
      p:last-child { margin-bottom: 0; }
    }

    .power-card__actions {
      display: flex;
      gap: 6px;
      // padding: 8px 12px 12px 54px;
      padding: 8px;
      justify-content: flex-end;

      .power-card__action {
        width: 28px;
        height: 28px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-muted);
        cursor: pointer;
        font-size: 0.75rem;
        transition: all var(--masks-transition-fast);

        &:hover {
          background: var(--masks-accent);
          color: white;
          border-color: var(--masks-accent);
        }

        &.power-card__action--delete:hover {
          background: var(--masks-danger-color);
          border-color: var(--masks-danger-color);
        }
      }
    }

    /* Highlight when expanded */
    &:has(.power-card__radio:checked) {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
  }
}

/* --- Playbook Tab --- */
.masks-sheet-v2 .playbook-tab {
  .playbook-section {
    margin-bottom: 8px;
    &:last-child { margin-bottom: 0; }
  }

  .playbook-section--features {
    .playbook-features {
      display: flex;
      flex-direction: column;
      gap: 12px;

      .cell {
        margin-bottom: 0;
        padding: 12px;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);

        .cell__title {
          font-size: 0.8rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          color: var(--masks-text-secondary);
          margin-bottom: 8px;

          &::before, &::after { display: none; }
        }

        .cell__description {
          font-size: 0.75rem;
          color: var(--masks-text-muted);
          font-style: italic;
          margin-bottom: 8px;
        }

        .editor {
          min-height: 80px;

          .editor-content {
            background: var(--masks-bg-sidebar);
            border: 1px solid var(--masks-border-color);
            border-radius: var(--masks-corner-radius);
            color: var(--masks-text-primary);
            padding: 8px;
          }
        }

        .cell__checkboxes {
          list-style: none;
          padding: 0;
          margin: 0;

          label.flexrow {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--masks-corner-radius);
            margin-bottom: 4px;
            color: var(--masks-text-secondary);
            font-size: 0.85rem;

            input[type="checkbox"] { accent-color: var(--masks-accent); }

            input[type="text"] {
              flex: 1;
              background: var(--masks-bg-sidebar);
              border: 1px solid var(--masks-border-color);
              border-radius: var(--masks-corner-radius);
              color: var(--masks-text-primary);
              padding: 4px 8px;
              font-size: 0.85rem;

              &:focus {
                outline: none;
                border-color: var(--masks-accent);
              }
            }
          }
        }
      }
    }

    .playbook-features-list {
      display: flex;
      flex-direction: column;
      gap: 16px;

      .playbook-feature {
        padding: 12px;
        background: var(--masks-bg-input);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);

        .feature-label {
          display: block;
          font-size: 0.8rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          color: var(--masks-text-secondary);
          margin-bottom: 8px;
        }

        .feature-description {
          font-size: 0.75rem;
          color: var(--masks-text-muted);
          font-style: italic;
          margin: 0 0 8px 0;
        }

        .editor {
          min-height: 120px;

          .editor-content {
            min-height: 100px;
            background: var(--masks-bg-sidebar);
            border: 1px solid var(--masks-border-color);
            border-radius: var(--masks-corner-radius);
            color: var(--masks-text-primary);
            padding: 8px;
          }
        }

        .feature-options {
          list-style: none;
          padding: 0;
          margin: 0;
          display: flex;
          flex-direction: column;
          gap: 4px;

          li {
            label {
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 6px 8px;
              background: rgba(255, 255, 255, 0.03);
              border-radius: var(--masks-corner-radius);
              color: var(--masks-text-secondary);
              font-size: 0.85rem;
              cursor: pointer;

              &:hover { background: rgba(255, 255, 255, 0.06); }

              input[type="checkbox"] {
                accent-color: var(--masks-accent);
                flex-shrink: 0;
              }

              .feature-checkboxes {
                display: flex;
                gap: 4px;
                flex-shrink: 0;

                input[type="checkbox"] { margin: 0; }
              }

              input[type="text"] {
                flex: 1;
                background: var(--masks-bg-sidebar);
                border: 1px solid var(--masks-border-color);
                border-radius: var(--masks-corner-radius);
                color: var(--masks-text-primary);
                padding: 4px 8px;
                font-size: 0.85rem;

                &:focus {
                  outline: none;
                  border-color: var(--masks-accent);
                }
              }
            }
          }
        }

        input[type="text"],
        input[type="number"] {
          width: 100%;
          background: var(--masks-bg-sidebar);
          border: 1px solid var(--masks-border-color);
          border-radius: var(--masks-corner-radius);
          color: var(--masks-text-primary);
          padding: 8px;
          font-size: 0.9rem;

          &:focus {
            outline: none;
            border-color: var(--masks-accent);
          }
        }

        .clock-tracker {
          display: flex;
          align-items: center;
          gap: 12px;

          .clock-pips {
            display: flex;
            gap: 6px;

            .clock-pip {
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: var(--masks-bg-sidebar);
              border: 2px solid var(--masks-danger-color);
              cursor: pointer;
              transition: all var(--masks-transition-fast);

              &:hover {
                transform: scale(1.1);
                box-shadow: 0 0 8px var(--masks-danger-color);
              }

              &.filled { background: var(--masks-danger-color); }
            }
          }

          .clock-count {
            font-size: 0.85rem;
            color: var(--masks-text-secondary);
          }
        }

        .number-tracker {
          display: flex;
          align-items: center;
          gap: 8px;

          .tracker-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--masks-corner-radius);
            background: var(--masks-bg-sidebar);
            border: 1px solid var(--masks-border-color);
            color: var(--masks-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--masks-transition-fast);

            &:hover {
              background: var(--masks-accent);
              color: var(--masks-text-primary);
              border-color: var(--masks-accent);
            }

            i { font-size: 0.75rem; }
          }

          .tracker-value {
            width: 50px;
            text-align: center;
            background: var(--masks-bg-sidebar);
            border: 1px solid var(--masks-border-color);
            border-radius: var(--masks-corner-radius);
            color: var(--masks-text-primary);
            padding: 6px;
            font-size: 1rem;
            font-weight: 600;

            &:focus {
              outline: none;
              border-color: var(--masks-accent);
            }
          }
        }
      }
    }
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;

    .section-title {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .moment-unlock-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--masks-text-muted);
      cursor: pointer;

      input { accent-color: var(--masks-accent); }
    }
  }

  .advancements-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .advancement-item {
    .advancement-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--masks-bg-input);
      border: 1px solid var(--masks-border-color);
      border-radius: var(--masks-corner-radius);
      cursor: pointer;
      transition: all var(--masks-transition-fast);

      &:hover { background: rgba(255, 255, 255, 0.05); }

      .advancement-checkboxes {
        display: flex;
        gap: 4px;
      }

      .advancement-check { accent-color: var(--masks-accent); }

      .advancement-text {
        flex: 1;
        font-size: 0.85rem;
        color: var(--masks-text-secondary);
      }

      .advancement-custom-text {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 1px solid var(--masks-border-color);
        color: var(--masks-text-primary);
        font-size: 0.85rem;
        padding: 2px 0;

        &:focus {
          outline: none;
          border-bottom-color: var(--masks-accent);
        }
      }
    }
  }

  .playbook-section--moment {
    padding: 12px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);

    .editor {
      min-height: 100px;

      .editor-content {
        background: var(--masks-bg-sidebar);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-primary);
        padding: 8px;
        min-height: 80px;
      }
    }
  }

  .playbook-section--combined-advances {
    padding: 12px;
    background: var(--masks-bg-input);
    border: 1px solid var(--masks-border-color);
    border-radius: var(--masks-corner-radius);
    border-left: 3px solid var(--masks-accent);

    .advances-subsection {
      .subsection-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--masks-accent);
        margin-bottom: 8px;
      }

      &--later .subsection-title { color: var(--masks-text-muted); }
    }

    .advances-divider {
      border: none;
      border-top: 1px solid var(--masks-border-color);
      margin: 16px 0;
    }
  }

  /* PbtA Clock Pattern */
  .cell__clock {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
    margin: 8px 0;

    .attr-clock {
      appearance: none;
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--masks-bg-input);
      border: 2px solid var(--masks-border-color);
      cursor: pointer;
      transition: all 0.15s ease;
      margin: 0;
      position: relative;

      &:hover {
        border-color: var(--masks-danger-color);
        background: rgba(224, 82, 82, 0.1);
      }

      &:checked {
        background: var(--masks-danger-color);
        border-color: var(--masks-danger-color);

        &:hover {
          background: #c94545;
          border-color: #c94545;
        }
      }
    }
  }

  .clock-count {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--masks-text-muted);
    margin-left: 4px;
  }

  /* PbtA ListMany Pattern */
  .cell__checkboxes {
    list-style: none;
    padding: 0;
    margin: 0;

    label.flexrow {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--masks-corner-radius);
      margin-bottom: 4px;
      color: var(--masks-text-secondary);
      font-size: 0.85rem;
      cursor: pointer;

      &:hover { background: rgba(255, 255, 255, 0.06); }

      input[type="checkbox"].attr-list {
        accent-color: var(--masks-accent);
        flex-shrink: 0;
        margin: 0;
      }

      input[type="text"].input-title {
        flex: 1;
        background: var(--masks-bg-sidebar);
        border: 1px solid var(--masks-border-color);
        border-radius: var(--masks-corner-radius);
        color: var(--masks-text-primary);
        padding: 4px 8px;
        font-size: 0.85rem;

        &:focus {
          outline: none;
          border-color: var(--masks-accent);
        }
      }
    }
  }
}
